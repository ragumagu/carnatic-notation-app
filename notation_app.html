<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
    <link rel="stylesheet" href="/carnatic-notation-app/styles/styles.css">
    <style>
        :root {
            --background-color: #fffff8;
            --text-color: #111;
            --image-filter: none;
        }
        
        body {
            background-color: var(--background-color);
            color: var(--text-color);
        }
        
        #aksharas_table {
            background-color: var(--background-color);
            border: 1px solid black;
            border-collapse: collapse;
            font-size: smaller;
        }
        
        #aksharas_table td {
            border: 1px solid black;
            border-collapse: collapse;
        }
        
        #aksharas_table td {

            height: 30px;
            width: 120px;
            justify-content: center;
            white-space: nowrap;
        }
        
        #aksharas_table td>button {
            background-color: var(--background-color);
            border: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        
        #aksharas_table td>button:hover {
            background-color: #dfdfdf;
        }
        
        #output {
            border: 1px solid brown;
            padding: 4px;
        }
        
        #input-container {
            display: flex;
            flex-direction: row;
            gap: 20px;
        }
        
        #input-container>* {
            flex: 1;
        }
        
        #text {
            background-color: var(--background-color);
            width: 90%;
            height: 90%;
        }
    </style>
</head>

<body>
    <h1> Notation: </h1>

    <label for="file_upload">Upload file for editing:</label>
    <input type="file" id="file-upload" name="file-upload" accept="text/html">

    <div id="input-container">
        <div>
            <table id="aksharas_table">
                <tr>
                    <td><button value="ಕ">ಕ</button></td>
                    <td><button value="ಕಿ">ಕಿ</button></td>
                    <td><button value="ಟ">ಟ</button></td>
                    <td><button value="ಕು">ಕು</button></td>
                </tr>
                <tr>
                    <td><button value="ಕಿಟ">ಕಿಟ</button></td>
                    <td><button value="ಕಿಟತಕ">ಕಿಟತಕ</button></td>
                    <td><button value="ಕಿಟತೊಂ,">ಕಿಟತೊಂ,</button></td>
                    <td><button value="ಕಿಟಕಿಟತೊಂ,">ಕಿಟಕಿಟತೊಂ,</button></td>
                </tr>
                <tr>
                    <td><button value="ಗಿ">ಗಿ</button></td>
                    <td><button value="ಗು">ಗು</button></td>
                    <td><button value="ಗುಂ">ಗುಂ</button></td>
                </tr>
                <tr>
                    <td><button value="ತ">ತ</button></td>
                    <td><button value="ರಿ">ರಿ</button></td>

                </tr>
                <tr>
                    <td><button value="ತಾ">ತಾ</button></td>
                    <td><button value="ತಾ,">ತಾ,</button></td>
                    <td><button value="ತಾ,,">ತಾ,,</button></td>
                    <td><button value="ತಾ,;">ತಾ,;</button></td>
                </tr>
                <tr>
                    <td><button value="ತಾಂ">ತಾಂ</button></td>
                    <td><button value="ತಾಂ,">ತಾಂ,</button></td>
                    <td><button value="ತಾಂಗು">ತಾಂಗು</button></td>
                    <td><button value="ತ್ಲಾಂ">ತ್ಲಾಂ</button></td>
                </tr>
                <tr>
                    <td><button value="ತೊ">ತೊ</button></td>
                    <td><button value="ತೊಂ">ತೊಂ</button></td>
                    <td><button value="ತೊಂ,">ತೊಂ,</button></td>
                    <td><button value="ತೊಂಗು">ತೊಂಗು</button></td>
                </tr>
                <tr>
                    <td><button value="ತಕ">ತಕ</button></td>
                    <td><button value="ತಕಿಟ">ತಕಿಟ</button></td>
                    <td><button value="ತರಿಕಿಟ">ತರಿಕಿಟ</button></td>
                </tr>
                <tr>
                    <td><button value="ತರಿಕಿಟತಕ">ತರಿಕಿಟತಕ</button></td>
                    <td><button value="ದಿಗುತರಿಕಿಟತಕ">ದಿಗುತರಿಕಿಟತಕ</button></td>
                    <td><button value="ತಾಂಕಿಟ ದಿಗುತರಿಕಿಟತಕ">ತಾಂಕಿಟ ದಿಗುತರಿಕಿಟತಕ</button></td>
                </tr>

                <tr>
                    <td><button value="ದಿ">ದಿ</button></td>
                    <td><button value="ಧಿ">ಧಿ</button></td>
                    <td><button value="ಧಿ,">ಧಿ,</button></td>
                    <td><button value="ತ,ದಿ,">ತ,ದಿ,</button></td>
                </tr>
                <tr>
                    <td><button value="ಧಿಂ">ಧಿಂ</button></td>
                    <td><button value="ಧಿಂ,">ಧಿಂ,</button></td>
                    <td><button value="ಧಿಂ,,">ಧಿಂ,,</button></td>
                    <td><button value="ಧಿಂ,;">ಧಿಂ,;</button></td>
                </tr>
                <tr>
                    <td><button value="ಧಿಂಕು">ಧಿಂಕು</button></td>
                    <td><button value="ಧುಂ">ಧುಂ</button></td>
                    <td><button value="ನ">ನ</button></td>
                    <td><button value="ನ್ನ">ನ್ನ</button></td>
                </tr>
                <tr>
                    <td><button value="ನಂ">ನಂ</button></td>
                    <td><button value="ಮಿ">ಮಿ</button></td>
                    <td><button value="ಣ">ಣ</button></td>
                    <td><button value="ಣು">ಣು</button></td>
                </tr>
                <tr>
                    <td><button value="ತಕದಿಮಿ ತಕಝಣು">ತಕದಿಮಿ ತಕಝಣು</button></td>
                    <td><button value="ತಕಝಣು">ತಕಝಣು</button></td>
                    <td><button value="ತಳಾಂಗು">ತಳಾಂಗು</button></td>
                </tr>
                <tr>
                    <td><button value="ತದಿಗಿಣತೊಂ">ತದಿಗಿಣತೊಂ</button></td>
                    <td><button value="ತಧಿಂ,ಗಿಣತೊಂ">ತಧಿಂ,ಗಿಣತೊಂ</button></td>
                    <td><button value="ತ,ಧಿಂ,ಗಿಣತೊಂ">ತ,ಧಿಂ,ಗಿಣತೊಂ</button></td>
                    <td><button value="ತಧಿಂ,ಗಿ,ಣ,ತೊಂ">ತಧಿಂ,ಗಿ,ಣ,ತೊಂ</button></td>
                    <td><button value="ತ,ಧಿಂ,ಗಿ,ಣ,ತೊಂ">ತ,ಧಿಂ,ಗಿ,ಣ,ತೊಂ</button></td>
                </tr>
                <tr>
                    <td><button value="ತದಿತ(ಕಿಟ)ತೊಂ">ತದಿತ<span class="su">ಕಿಟ</span>ತೊಂ</button></td>
                    <td><button value="ತಧಿಂ,ತ(ಕಿಟ)ತೊಂ">ತಧಿಂ,ತ<span class="su">ಕಿಟ</span>ತೊಂ</button></td>
                    <td><button value="ತ,ಧಿಂ,ತ(ಕಿಟ)ತೊಂ">ತ,ಧಿಂ,ತ<span class="su">ಕಿಟ</span>ತೊಂ</button></td>

                </tr>
                <tr>
                    <td><button value="">ತ,; ಧಿಂ,; ಗಿ,; ಣ,; ತೊಂ,;</button></td>
                    <td><button value="">ತ,, ಧಿಂ,, ಗಿ,, ಣ,, ತೊಂ,,</button></td>
                    <td><button value="">ತ, ಧಿಂ, ಗಿ, ಣ, ತೊಂ,</button></td>
                </tr>
            </table>
        </div>

        <div>
            <textarea id="text" rows="6" width="400" placeholder="Type here to see output..."></textarea>

            <div id="nav-links">
                <label>Pages:</label>
                <button id="fast-backward-page">&lt;&lt;</button>
                <button id="previous-page">&lt;</button>
                <button id="home-page">Home &#127968;</button>
                <div id="page-numbers-window"></div>
                <button id="next-page">&gt;</button>
                <button id="fast-forward-page">&gt;&gt;</button>
            </div>

            <div>
                <button id="new-page-button">New page</button>
            </div>
        </div>


    </div>

    <h3>Page preview:</h3>

    <label>Show syllable counts:</label>
    <input type="checkbox" id="show-counts-checkbox">

    <div id="output"></div>

    <div>
        <button id="download-button">Save and download</button>
    </div>


    <script>
        var book = [""];
        var current_page = 0;
    </script>

    <script src="scripts/notation_core.js"></script>
    <script src="scripts/book_utils.js"></script>

    <script>
        var text_input_mode = "table";

        function add_text(e) {
            console.log(e);
            let text = document.getElementById("text");
            let cursor_pos = text.selectionEnd;
            let offset = 0;

            let inp_text = e.currentTarget.value;

            if (!(text.value === "")) {
                text.value = text.value.substring(0, cursor_pos) + inp_text + " " + text.value.substring(cursor_pos);
                offset = inp_text.length + 1;
            } else {
                let new_text = inp_text;
                if (text_input_mode === "table") {
                    new_text = "*|| " + inp_text + " " + " ||*";
                    offset = "*|| ".length + inp_text.length + 1;
                } else {
                    offset = new_text.length;
                }
                text.value = new_text;
            }

            book[current_page] = text.value;
            render_text(book[current_page], document.getElementById("output"));
            text.focus();
            text.selectionEnd = cursor_pos + offset;

        };

        document.getElementById("aksharas_table").childNodes.forEach((tbody) => {
            tbody.childNodes.forEach((tr) => {
                tr.childNodes.forEach((td) => {
                    if (td.nodeType === 1) {
                        td.firstChild.onclick = add_text;
                    }
                })
            })
        });

        document.getElementById('text').onkeydown = (e) => {
            let text = document.getElementById("text");
            let cursor_pos = text.selectionEnd;
            console.log("keydown text", text.selectionStart, text.selectionEnd);
            if (e.code === "Backspace") {
                if (text.selectionEnd === text.selectionStart) {
                    e.preventDefault();
                    start = cursor_pos - 1;
                    while (isDiacritic(text.value.substring(start, start + 1)) && start > 0) {
                        start--;
                    }
                    console.log("Backspace will remove:'" + text.value.substring(start, cursor_pos) + "'", text.value.substring(start, cursor_pos) in aksharas);

                    text.value = text.value.substring(0, start) + text.value.substring(cursor_pos);
                    text.selectionEnd = start;
                }
            }

        }

        document.getElementById("text").onkeyup = (e) => {
            console.log("onkeyup, text changed", e.code, e.key);

            let text = document.getElementById("text");
            let cursor_pos = text.selectionEnd;

            let paired_input = false;

            if (e.code === "Enter") {
                let cursor_is_in_middle_of_line = false;
                if (text.value.length > cursor_pos && (!(text.value[cursor_pos] === "\n"))) {
                    cursor_is_in_middle_of_line = true;
                }
                console.log('text, cursor_pos', text.value, cursor_pos, cursor_is_in_middle_of_line);

                if (text_input_mode === "table" && cursor_is_in_middle_of_line) {
                    text.value = text.value.substring(0, cursor_pos - 1) + "||\n|| " + text.value.substring(cursor_pos);
                    text.selectionEnd = cursor_pos + "||\n|| ".length - 1;
                }
            } else if (["(", "[", "{", "*"].includes(e.key)) {
                paired_input = true;
            }

            console.log("paired input", paired_input);
            if (paired_input) {
                let matching = {
                    "(": ")",
                    "[": "]",
                    "{": "}",
                    "*": "*"
                };
                text.value = text.value.substring(0, cursor_pos) + matching[e.key] + text.value.substring(cursor_pos);
                text.selectionEnd = cursor_pos;
            }

            book[current_page] = text.value;
            render_text(book[current_page], document.getElementById("output"));
        };



        document.getElementById("file-upload").onchange = (e) => {
            if (e.target.files[0]) {
                const reader = new FileReader()
                reader.onload = (e) => {
                    let text = e.target.result;
                    start = text.indexOf("var book=");
                    end = text.indexOf(";//end-of-book");
                    if (start === -1 || end === -1) {
                        let alert_message = "Could not parse uploaded file.\n" +
                            "Please try to recover by these steps:\n1. Open the file in a browser, \n" +
                            "2. Copy and paste the content into the input box, recreate the styling, and \n" +
                            "3. Download the file again."
                        alert(alert_message);
                    }
                    if (start !== -1) {
                        start += "var book=".length;
                    }

                    book = JSON.parse(text.substring(start, end));

                    start = text.indexOf("var current_page=");
                    end = text.indexOf(";//end-of-current-page");
                    if (start === -1 || end === -1) {
                        current_page = 0;
                    }

                    if (start !== -1) {
                        start += "var current_page=".length;
                        current_page = parseInt(text.substring(start, end));
                    }

                    document.getElementById('text').value = book[current_page];
                    render_text(book[current_page], document.getElementById("output"));
                    update_page_numbers_window();
                };

                reader.readAsText(e.target.files[0])
            }
        };

        function download(text) {
            // From https://stackoverflow.com/a/48550997
            text = text.replace(/\n/g, "\r\n"); // To retain the Line breaks.
            var blob = new Blob([text], {
                type: "text/plain"
            });
            var anchor = document.createElement("a");
            anchor.download = "notation.html";
            anchor.href = window.URL.createObjectURL(blob);
            anchor.target = "_blank";
            anchor.style.display = "none"; // just to be safe!
            document.body.appendChild(anchor);
            anchor.click();
            document.body.removeChild(anchor);
        }


        var notation_script = null;

        fetch("/carnatic-notation-app/scripts/notation_core.js")
            .then((response) => response.text())
            .then((text) => {
                return text;
            }).then((t) => {
                notation_script = t;
            })
            .catch((error) => {
                console.log(error);
            });

        var stylesheet = null;

        fetch("/carnatic-notation-app/styles/styles.css")
            .then((response) => response.text())
            .then((text) => {
                return text;
            }).then((t) => {
                stylesheet = t;
            })
            .catch((error) => {
                console.log(error);
            });

        var book_utils = null;
        fetch("/carnatic-notation-app/scripts/book_utils.js")
            .then((response) => response.text())
            .then((text) => {
                return text;
            }).then((t) => {
                book_utils = t;
            })
            .catch((error) => {
                console.log(error);
            });


        document.getElementById("download-button").onclick = async(e) => {

            let content = document.getElementById("text").value;
            let html =
                `<!DOCTYPE html><html>
                    <head>
                        <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
                        <style>
                            ${stylesheet}
                        </style>
                    </head>
                    <body>
                        <div id="output"></div>

                        <div id="nav-links">
                            <label>Pages:</label>
                            <button id="fast-backward-page">&lt;&lt;</button>
                            <button id="previous-page">&lt;</button>
                            <button id="home-page">Home &#127968;</button>
                            <div id="page-numbers-window"></div>
                            <button id="next-page">&gt;</button>
                            <button id="fast-forward-page">&gt;&gt;</button>
                        </div>

                        <script>
                            var book=${JSON.stringify(book)};//end-of-book
                            var current_page = ${current_page};//end-of-current-page
                        <\/script>

                        <script>${notation_script}<\/script>

                        <script>${book_utils}<\/script>
                        <script>
                            render_text(book[current_page], document.getElementById("output"));
                        <\/script>
                    </body>
                </html>`;
            download(html);
        };
    </script>
</body>

</html>